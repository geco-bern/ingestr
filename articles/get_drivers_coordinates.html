<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ingest P-model drivers from coordinates • ingestr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Ingest P-model drivers from coordinates">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>ingestr <small>v1.4.1</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/calc_daytime_vpd.html">Derived fluxnet variables</a>
    </li>
    <li>
      <a href="../articles/collect_point_environment.html">Collect point-scale climate and soil information</a>
    </li>
    <li>
      <a href="../articles/example.html">ingestr example</a>
    </li>
    <li>
      <a href="../articles/get_drivers_coordinates.html">Ingest P-model drivers from coordinates</a>
    </li>
    <li>
      <a href="../articles/get_evi_gee.html">Getting MODIS EVI data from Google Earth Engine</a>
    </li>
    <li>
      <a href="../articles/ingest_cru_rsofun.html">ingest CRU</a>
    </li>
    <li>
      <a href="../articles/modis_interpolation.html">Interpolation of MODIS data</a>
    </li>
    <li>
      <a href="../articles/run_pmodel_points.html">Run the P-model for point simulations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/geco-bern/ingestr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ingest P-model drivers from coordinates</h1>
                        <h4 data-toc-skip class="author">Pepa Aran</h4>
            
            <h4 data-toc-skip class="date">2023-03-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/geco-bern/ingestr/blob/master/vignettes/get_drivers_coordinates.Rmd" class="external-link"><code>vignettes/get_drivers_coordinates.Rmd</code></a></small>
      <div class="hidden name"><code>get_drivers_coordinates.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="get-all-p-model-drivers-from-a-pair-of-coordinates">Get all P-model drivers from a pair of coordinates<a class="anchor" aria-label="anchor" href="#get-all-p-model-drivers-from-a-pair-of-coordinates"></a>
</h2>
<p>This vignette runs through the workflow to obtain an object like
<code>p_model_drivers</code> (from the <code>rsofun</code> package) for
arbitrary locations in the globe, given by their coordinates (lon, lat).
These sites aren’t necessarily flux sites.</p>
<p>First, we compile all the necessary data (complete site information,
meteorological data, climatic variables, etc.) from the raw data files.
In this vignette, we use the paths corresponding to the GECO data
archive (more information <a href="https://github.com/geco-bern/data_management" class="external-link">here</a>). Then, we
format the data to run the <a href="https://geco-bern.github.io/rsofun/" class="external-link">rsofun</a> P-model
implementation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/geco-bern/ingestr" class="external-link">ingestr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">devtools</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"geco-bern/rsofun"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/geco-bern/rsofun" class="external-link">rsofun</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="site-information-and-coordinates">Site information and coordinates<a class="anchor" aria-label="anchor" href="#site-information-and-coordinates"></a>
</h3>
<p>As an example, we will use a subset of site locations from Atkin et
al. 2017 (the original data is available via the <a href="https://www.try-db.org/de/Datasets.php" class="external-link">TRY Plant Trait
Database</a>). All the columns in the <code>siteinfo_globresp</code>
data.frame are necessary to retrieve the P-model drivers data: a site
name for reference <code>sitename</code>, the coordinates of the site
location in degrees <code>lon</code> and <code>lat</code>, its elevation
in meters <code>elv</code>, and the first and last year of observations
we want to collect <code>year_start</code> and
<code>year_end</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load siteinfo data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"../data/siteinfo_globresp.rda"</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="complement-siteinfo-with-water-holding-capacity">Complement siteinfo with Water Holding Capacity<a class="anchor" aria-label="anchor" href="#complement-siteinfo-with-water-holding-capacity"></a>
</h4>
<p>We use data from <a href="https://www.nature.com/articles/s41561-023-01125-2" class="external-link">Stocker et
al. 2021</a> to get the WHC for our sites. The data is in 0.05 degree
resolution, which is appropriate for this use case.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define function to extract whc</span></span>
<span><span class="va">extract_whc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span>, <span class="va">siteinfo</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">siteinfo</span> <span class="op">&lt;-</span> <span class="va">siteinfo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span>                                   <span class="co"># Remove repeated coordinates</span></span>
<span>  </span>
<span>  <span class="va">rasta</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu">brick</span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">raster</span><span class="fu">::</span><span class="fu">extract</span><span class="op">(</span></span>
<span>    <span class="va">rasta</span>,                                            <span class="co"># raster object</span></span>
<span>    <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/SpatialPoints.html" class="external-link">SpatialPoints</a></span><span class="op">(</span><span class="va">siteinfo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,   <span class="co"># points</span></span>
<span>    sp <span class="op">=</span> <span class="cn">TRUE</span>                                         <span class="co"># add raster values to siteinfo</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>whc <span class="op">=</span> <span class="va">layer</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get WHC data</span></span>
<span><span class="va">path_whc</span> <span class="op">&lt;-</span> <span class="st">"/data/archive/whc_stocker_2021/data"</span></span>
<span></span>
<span><span class="va">df_whc</span> <span class="op">&lt;-</span> <span class="fu">extract_whc</span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_whc</span>, <span class="st">"/cwdx80.nc"</span><span class="op">)</span>,</span>
<span>            siteinfo <span class="op">=</span> <span class="va">siteinfo_globresp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge whc with site information</span></span>
<span><span class="va">siteinfo</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">siteinfo_globresp</span>,</span>
<span>  <span class="va">df_whc</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Fill gaps by median value (here there are no NAs)</span></span>
<span><span class="va">siteinfo</span><span class="op">$</span><span class="va">whc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">siteinfo</span><span class="op">$</span><span class="va">whc</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">siteinfo</span><span class="op">$</span><span class="va">whc</span>,</span>
<span>                                            na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="get-forcing-datasets">Get forcing datasets<a class="anchor" aria-label="anchor" href="#get-forcing-datasets"></a>
</h3>
<p>Based on the <code>siteinfo</code> object, we collect all climate
forcing data.</p>
<div class="section level4">
<h4 id="meteorological-forcing-from-watch-wfdei">Meteorological forcing from WATCH-WFDEI<a class="anchor" aria-label="anchor" href="#meteorological-forcing-from-watch-wfdei"></a>
</h4>
<p>The following meteorological variables are obtained for the P-model
forcing from the <a href="https://rda.ucar.edu/datasets/ds314.2/" class="external-link">WATCH-WFDEI</a> data: -
<code>temp</code>: Daily temperature - <code>prec</code>: Daily
precipitation - <code>ppfd</code>: Photosynthetic photon flux density -
<code>vpd</code>: Vapor pressure deficit - <code>patm</code>:
Atmospheric pressure</p>
<p>Loading this data can take a while, up to hours if you need several
years of data for many sites.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get WATCH data</span></span>
<span><span class="va">path_watch</span> <span class="op">&lt;-</span> <span class="st">"/data/archive/wfdei_weedon_2014/data"</span></span>
<span><span class="va">path_worldclim</span> <span class="op">&lt;-</span> <span class="st">"/data/archive/worldclim_fick_2017/data"</span> <span class="co"># for debiasing</span></span>
<span></span>
<span><span class="va">df_watch</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="../reference/ingest.html">ingest</a></span><span class="op">(</span></span>
<span>  siteinfo <span class="op">=</span> <span class="va">siteinfo</span>,</span>
<span>  source <span class="op">=</span> <span class="st">"watch_wfdei"</span>,</span>
<span>  getvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"temp"</span>, <span class="st">"prec"</span>, <span class="st">"ppfd"</span>, <span class="st">"vpd"</span>, <span class="st">"patm"</span><span class="op">)</span>,</span>
<span>  dir <span class="op">=</span> <span class="va">path_watch</span>,</span>
<span>  settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    correct_bias <span class="op">=</span> <span class="st">"worldclim"</span>,    <span class="co"># 0.5 deg</span></span>
<span>    dir_bias <span class="op">=</span> <span class="va">path_worldclim</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Variables tmin and tmax missing but not currently in use</span></span>
<span></span>
<span><span class="co"># Memory intensive, purge memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="cloud-cover-from-cru">Cloud cover from CRU<a class="anchor" aria-label="anchor" href="#cloud-cover-from-cru"></a>
</h4>
<p>Now, let’s complete the forcing with cloud cover <code>ccov</code>
values from <a href="https://crudata.uea.ac.uk/cru/data/hrg/" class="external-link">CRU</a>
data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get CRU data</span></span>
<span><span class="va">path_cru</span> <span class="op">&lt;-</span> <span class="st">"/data/archive/cru_NA_2021/data/"</span></span>
<span></span>
<span><span class="va">df_cru</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="../reference/ingest.html">ingest</a></span><span class="op">(</span></span>
<span>  siteinfo <span class="op">=</span> <span class="va">siteinfo</span>,</span>
<span>  source <span class="op">=</span> <span class="st">"cru"</span>,</span>
<span>  getvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ccov"</span><span class="op">)</span>,</span>
<span>  dir <span class="op">=</span> <span class="va">path_cru</span>,</span>
<span>  settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    correct_bias <span class="op">=</span> <span class="cn">NULL</span>       <span class="co"># 0.5 deg resolution</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="merge-meteorological-drivers">Merge meteorological drivers<a class="anchor" aria-label="anchor" href="#merge-meteorological-drivers"></a>
</h4>
<p>Let’s put together the previous data, into a single data.frame:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_meteo</span> <span class="op">&lt;-</span> <span class="va">df_watch</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">df_cru</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sitename"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>                         <span class="co"># keep unnested</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>tmin <span class="op">=</span> <span class="va">temp</span>,                  <span class="co"># placeholders for variables tmin and tmax</span></span>
<span>                tmax <span class="op">=</span> <span class="va">temp</span><span class="op">)</span> <span class="op">|&gt;</span>               <span class="co"># (not used in P-model runs)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>doy <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">yday</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>  <span class="co"># add day of year</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_meteo</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="get-co2-data">Get CO2 data<a class="anchor" aria-label="anchor" href="#get-co2-data"></a>
</h4>
<p>The following chunk downloads the CO2 yearly average data from the
Mauna Loa observatory and appends it to the meteorological drivers from
above.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download CO2 data</span></span>
<span><span class="va">df_co2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_annmean_mlo.csv"</span><span class="op">)</span>,</span>
<span>  skip <span class="op">=</span> <span class="fl">59</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">mean</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>co2 <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge with meteo drivers</span></span>
<span><span class="va">df_meteo</span> <span class="op">&lt;-</span> <span class="va">df_meteo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df_co2</span>, by <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span>            <span class="co"># keep unnested</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="append-fapar">Append fAPAR<a class="anchor" aria-label="anchor" href="#append-fapar"></a>
</h4>
<p>Set fAPAR by default to 1 for all observations, which is the same as
what <code>ingest(siiteinfo_globresp, source = "fapar_unity")</code>
would do. This makes sense for leaf-level simulations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add fapar column with value 1</span></span>
<span><span class="va">df_meteo</span> <span class="op">&lt;-</span> <span class="va">df_meteo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fapar <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="put-all-data-together-into-rsofun-object">Put all data together into rsofun object<a class="anchor" aria-label="anchor" href="#put-all-data-together-into-rsofun-object"></a>
</h3>
<p>Up to here, we have merged all of the forcing data into
<code>df_meteo</code>. Let’s put it in a nested format, such that there
is a single data.frame per site:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Nest forcing</span></span>
<span><span class="va">df_meteo</span> <span class="op">&lt;-</span> <span class="va">df_meteo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>forcing <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add site information</span></span>
<span><span class="va">df_siteinfo</span> <span class="op">&lt;-</span> <span class="va">siteinfo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>site_info <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We will use default simulation and soil texture parameters.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define default model parameters, soil data, etc</span></span>
<span><span class="va">params_siml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    spinup             <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># to bring soil moisture to steady state</span></span>
<span>    spinupyears        <span class="op">=</span> <span class="fl">10</span>,    <span class="co"># 10 is enough for soil moisture.</span></span>
<span>    recycle            <span class="op">=</span> <span class="fl">1</span>,     <span class="co"># number of years recycled during spinup </span></span>
<span>    soilmstress        <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># soil moisture stress function is included</span></span>
<span>    tempstress         <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># temperature stress function is included</span></span>
<span>    calc_aet_fapar_vpd <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># set to FALSE - should be dropped again</span></span>
<span>    in_ppfd            <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># if available from forcing files, set to TRUE</span></span>
<span>    in_netrad          <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># if available from forcing files, set to TRUE</span></span>
<span>    outdt              <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    ltre               <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    ltne               <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    ltrd               <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    ltnd               <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    lgr3               <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    lgn3               <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    lgr4               <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">df_soiltexture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    top    <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      layer <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>      fsand <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      fclay <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>      forg <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>      fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    bottom <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      layer <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      fsand <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>      fclay <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>      forg <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>      fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Finally, we can compile all the data together into a
<code>p_model_drivers</code> object. Note that this object must be an
ungrouped tibble object.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">drivers</span> <span class="op">&lt;-</span> <span class="va">df_meteo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df_siteinfo</span>,</span>
<span>                   by <span class="op">=</span> <span class="st">"sitename"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">drivers</span><span class="op">$</span><span class="va">params_siml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">params_siml</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">drivers</span><span class="op">$</span><span class="va">params_soil</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">df_soiltexture</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="run-p-model-example">Run P-model example<a class="anchor" aria-label="anchor" href="#run-p-model-example"></a>
</h2>
<p>We can now run the P-model with the <code>rsofun</code>
implementation.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run P-model with parameters from previous optimizations</span></span>
<span><span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio           <span class="op">=</span> <span class="fl">0.09423773</span>,</span>
<span>    soilm_par_a     <span class="op">=</span> <span class="fl">0.33349283</span>,</span>
<span>    soilm_par_b     <span class="op">=</span> <span class="fl">1.45602286</span>,</span>
<span>    tau_acclim_tempstress <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    par_shape_tempstress  <span class="op">=</span> <span class="fl">0.0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># run the model for these parameters</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="fu">runread_pmodel_f</span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">drivers</span>,</span>
<span>  par <span class="op">=</span> <span class="va">params_modl</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And take a look at the results:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">output</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">vcmax25</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Vcmax25"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">output</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">gpp</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"GPP"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="aggregate-over-2001-2015-period-to-obtain-across-years-average-forcing">Aggregate over 2001-2015 period to obtain across-years average
forcing<a class="anchor" aria-label="anchor" href="#aggregate-over-2001-2015-period-to-obtain-across-years-average-forcing"></a>
</h3>
<p>To run the P-model for leaf trait calibration, we may want to have
the average daily forcing over a span of years. This is because leaf
traits are measured once and assumed constant over a span of time.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define function to aggregate forcing over day of year</span></span>
<span><span class="va">aggregate_forcing_doy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">forcing</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">forcing</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">doy</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,                <span class="co"># 2001 as symbolic date</span></span>
<span>              temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              rain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rain</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              vpd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">vpd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              ppfd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ppfd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              snow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">snow</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              co2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">co2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              fapar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">fapar</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              patm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">patm</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              tmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tmin</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tmax</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              ccov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ccov</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>              <span class="op">)</span> <span class="op">|&gt;</span>                               <span class="co"># already ungrouped</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">365</span><span class="op">)</span>                          <span class="co"># ignore leap years</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute aggregated drivers</span></span>
<span><span class="va">drivers_aggregated</span> <span class="op">&lt;-</span> <span class="va">drivers</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>forcing <span class="op">=</span> </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">drivers</span><span class="op">$</span><span class="va">forcing</span>, <span class="va">aggregate_forcing_doy</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, let’s run the P-model on the aggregated data and visualise
the results.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run the model for these parameters</span></span>
<span><span class="va">output_aggregated</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="fu">runread_pmodel_f</span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">drivers_aggregated</span>,</span>
<span>  par <span class="op">=</span> <span class="va">params_modl</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">output_aggregated</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">vcmax25</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Vcmax25"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">output_aggregated</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">gpp</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.8</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"GPP"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>```</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>






  </body>
</html>
